<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shorts Editor - Wanendira</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Alata&family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root{--navy-dark:#0A192F;--gold-accent:#F7B733;--navy-light:#132F4C;--text-primary:#E6F1FF;--text-secondary:#8892B0;--hover-bg:#1d3b5c;--error-color:#ff4d4d}
        body{background-color:var(--navy-dark);color:var(--text-primary);font-family:'Nunito',sans-serif;margin:0}
        header{display:flex;justify-content:space-between;align-items:center;padding:20px 5%;border-bottom:1px solid var(--navy-light)}
        .brand-logo{font-family:'Alata',sans-serif;font-size:2em;color:var(--text-primary);text-decoration:none}
        .brand-logo span{color:var(--gold-accent)}
        main{padding:40px 5%;display:flex;flex-direction:column;align-items:center;flex-grow:1}
        .editor-container{width:100%;max-width:800px;display:flex;flex-direction:column;gap:25px}
        h1{font-family:'Alata',sans-serif;font-size:clamp(2rem, 5vw, 2.8rem);text-align:center;color:var(--gold-accent);margin-top:0;margin-bottom:20px}
        label{font-weight:700;font-size:1.1em;margin-bottom:8px;display:block}
        .label-wrapper { display: flex; justify-content: space-between; align-items: center; }
        .ide-generator-btn { background: none; border: 1px solid var(--gold-accent); color: var(--gold-accent); font-size: 0.8em; padding: 4px 8px; border-radius: 5px; cursor: pointer; transition: all 0.2s ease; }
        .ide-generator-btn:hover { background-color: var(--gold-accent); color: var(--navy-dark); }
        textarea{width:100%;padding:15px;border-radius:5px;border:1px solid var(--navy-light);background-color:var(--navy-light);color:var(--text-primary);font-family:'Nunito',sans-serif;font-size:1em;box-sizing:border-box;min-height:150px;resize:vertical}
        .custom-select-wrapper{position:relative;width:100%}.select-hidden{display:none}.select-styled{display:flex;justify-content:space-between;align-items:center;background-color:var(--navy-light);padding:15px;border-radius:5px;border:1px solid var(--navy-light);cursor:pointer;transition:all .2s ease-in-out}.select-styled:hover{border-color:var(--gold-accent)}.select-styled.active{border-color:var(--gold-accent);border-radius:5px 5px 0 0}.select-styled::after{content:"";width:0;height:0;border-left:6px solid transparent;border-right:6px solid transparent;border-top:6px solid var(--text-secondary)}.select-options{display:none;position:absolute;top:100%;left:0;right:0;z-index:99;background-color:var(--navy-light);border-radius:0 0 5px 5px;border:1px solid var(--gold-accent);border-top:0;max-height:250px;overflow-y:auto}.select-options .option-item{padding:15px;color:var(--text-primary);cursor:pointer;transition:all .2s ease-in-out;border-top:1px solid #1a334f}.select-options .option-item:hover{background-color:var(--hover-bg);color:var(--gold-accent)}.optgroup-label{padding:10px 15px;color:var(--gold-accent);font-family:'Alata',sans-serif;font-weight:bold;font-size:0.9em;text-transform:uppercase;border-top:1px solid #1a334f;background-color:var(--navy-dark)}.select-options .option-item:first-of-type, .optgroup-label:first-child{border-top:none}
        .generate-button{background-color:var(--gold-accent);color:var(--navy-dark);border:none;padding:16px 30px;border-radius:5px;cursor:pointer;font-family:'Nunito',sans-serif;font-weight:800;font-size:1.2em;transition:all .3s ease;width:100%;margin-top:10px}
        .generate-button:disabled{background-color:var(--text-secondary);cursor:not-allowed}
        .hasil-container{margin-top:30px;width:100%;padding:25px;background-color:var(--navy-light);border-radius:10px;min-height:200px;border:1px dashed var(--text-secondary);box-sizing:border-box}
        .hasil-container h3{font-family:'Alata',sans-serif;color:var(--gold-accent);margin-top:0;font-size:1.5em;border-bottom: 1px solid var(--navy-dark); padding-bottom: 10px; margin-bottom: 20px;}
        #hasil-content > * { margin-bottom: 15px; }
        .hasil-subjudul { color: var(--gold-accent); font-family: 'Alata'; font-size: 1.2em; margin-bottom: 5px !important; }
        .hasil-deskripsi, .hasil-tags, .hasil-hashtags { color: var(--text-secondary); font-style: italic; line-height: 1.6; }
        .segment-block { background-color: var(--navy-dark); padding: 15px; border-radius: 8px; border-left: 3px solid var(--gold-accent); margin-top: 10px; }
        .segment-title { font-weight: 800; color: var(--text-primary); margin-bottom: 10px !important; }
        .segment-narasi { color: var(--text-primary); line-height: 1.6; }
        .segment-prompt { color: var(--text-secondary); font-size: 0.9em; line-height: 1.5; font-style: italic; margin-top: 10px; padding-top: 10px; border-top: 1px dashed #2c4a6e; }
        .error-message {color: var(--error-color) !important; font-weight: bold;}
        .action-buttons { display: none; width: 100%; justify-content: flex-end; gap: 10px; margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--navy-dark); }
        .action-buttons button { font-size: 0.9em; padding: 8px 16px; background: var(--navy-dark); color: var(--gold-accent); border: 1px solid var(--gold-accent); cursor: pointer; border-radius: 5px; transition: all 0.2s ease;}
        .action-buttons button:hover { background-color: var(--gold-accent); color: var(--navy-dark); }
    </style>
</head>
<body>
    <header> <a href="index.html" class="brand-logo">Wanendira<span>.</span></a> </header>
    <main>
        <div class="editor-container">
            <h1>Shorts Editor</h1>
            <div class="custom-select-wrapper"><label for="kategori">1. Kategori Konten</label><select id="kategori" class="select-hidden"><option value="motivasi">Shorts Motivasi</option><option value="cerpen">Shorts Cerita Pendek</option><option value="fakta-sejarah">Shorts Fakta Sejarah</option></select></div>
            <div class="label-wrapper">
                <label for="ide">2. Ide Utamamu</label>
                <button id="btnBuatIde" class="ide-generator-btn">✨ Buatkan Ide</button>
            </div>
            <textarea id="ide" placeholder="Klik 'Buatkan Ide' atau tulis idemu sendiri..."></textarea>
            <div class="custom-select-wrapper"><label for="gaya-bahasa">3. Gaya Bahasa</label><select id="gaya-bahasa" class="select-hidden"><optgroup label="Gaya Motivasi"><option value="Tegas & Santai (Gaya 'Bro')">Tegas & Santai (Gaya 'Bro')</option><option value="Inspiratif & Puitis">Inspiratif & Puitis</option></optgroup><optgroup label="Gaya Narasi"><option value="Narator Dongeng (Hangat & Imajinatif)">Narator Dongeng</option><option value="Pencerita Epik (Dramatis & Megah)">Pencerita Epik</option></optgroup><optgroup label="Gaya Edukasi"><option value="Presenter Antusias (Cepat & Enerjik)">Presenter Antusias</option><option value="Pakar Tenang (Jelas & Berwibawa)">Pakar Tenang</option></optgroup></select></div>
            <div class="custom-select-wrapper"><label for="gaya-visual">4. Gaya Visual</label><select id="gaya-visual" class="select-hidden"><option value="cinematic">Cinematic (Realistis)</option><option value="anime">Anime</option><option value="kartun-3d">Kartun 3D</option></select></div>
            <button id="generateBtn" class="generate-button">✨ Buat Skrip Lengkap!</button>
            
            <div class="hasil-container">
                <h3>Hasil Skrip & Prompt Visual</h3>
                <div id="hasil-content">
                    <p style="color: var(--text-secondary);">Hasil lengkap akan muncul di sini...</p>
                </div>
                <!-- === TOMBOL AKSI DIPINDAHKAN KE SINI === -->
                <div id="actionButtons" class="action-buttons">
                    <button id="btnCopy">Salin</button>
                    <button id="btnDownload">Unduh (.txt)</button>
                    <button id="btnSave">Simpan Riwayat</button>
                </div>
            </div>
        </div>
    </main>

    <script>
    // Seluruh kode JavaScript dari sebelumnya tetap sama persis,
    // karena perubahannya hanya ada di HTML dan CSS.
    // ... (tempel semua kode JavaScript dari blok kode sebelumnya di sini)
    document.addEventListener('DOMContentLoaded', function() {
        // BAGIAN 1: LOGIKA DROPDOWN CUSTOM
        document.querySelectorAll('.custom-select-wrapper').forEach(function(wrapper) {
            const selectElement = wrapper.querySelector('select');
            const styledSelect = document.createElement('div');
            styledSelect.setAttribute('class', 'select-styled');
            styledSelect.textContent = selectElement.options[selectElement.selectedIndex].text;
            
            const optionsList = document.createElement('div');
            optionsList.setAttribute('class', 'select-options');
            
            const options = Array.from(selectElement.children);
            
            options.forEach(function(item) {
                if (item.tagName === 'OPTGROUP') {
                    const groupLabel = document.createElement('div');
                    groupLabel.textContent = item.label;
                    groupLabel.classList.add('optgroup-label');
                    optionsList.appendChild(groupLabel);
                    
                    const groupOptions = Array.from(item.children);
                    groupOptions.forEach(function(option) {
                        addOption(option);
                    });
                } else {
                    addOption(item);
                }
            });

            function addOption(option) {
                const optionDiv = document.createElement('div');
                optionDiv.textContent = option.textContent;
                optionDiv.classList.add('option-item');
                optionDiv.setAttribute('data-value', option.value);
                
                optionDiv.addEventListener('click', function(e) {
                    e.stopPropagation();
                    styledSelect.textContent = this.textContent;
                    selectElement.value = this.getAttribute('data-value');
                    optionsList.style.display = 'none';
                    styledSelect.classList.remove('active');
                });
                optionsList.appendChild(optionDiv);
            }
            
            wrapper.appendChild(styledSelect);
            wrapper.appendChild(optionsList);
            
            styledSelect.addEventListener('click', function(e) {
                e.stopPropagation();
                closeAllSelects(this);
                const isHidden = optionsList.style.display === 'none' || optionsList.style.display === '';
                optionsList.style.display = isHidden ? 'block' : 'none';
                this.classList.toggle('active', isHidden);
            });
        });
        
        function closeAllSelects(elmnt) {
            document.querySelectorAll('.select-options').forEach(function(options) {
                if (!elmnt || elmnt.nextSibling !== options) {
                    options.style.display = 'none';
                    if (options.previousSibling && options.previousSibling.classList) {
                       options.previousSibling.classList.remove('active');
                    }
                }
            });
        }
        
        document.addEventListener('click', function() {
            closeAllSelects(null);
        });

        // BAGIAN 2: LOGIKA FITUR-FITUR APLIKASI
        const generateBtn = document.getElementById('generateBtn');
        const hasilContent = document.getElementById('hasil-content');
        const btnBuatIde = document.getElementById('btnBuatIde');
        const ideTextarea = document.getElementById('ide');
        const actionButtons = document.getElementById('actionButtons');
        let fullScriptText = '';

        btnBuatIde.addEventListener('click', async () => {
            const kategori = document.getElementById('kategori').value;
            btnBuatIde.disabled = true;
            btnBuatIde.textContent = 'Mencari...';

            try {
                const response = await fetch('/api/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ task: 'generate_idea', kategori: kategori }),
                });
                const data = await response.json();
                if (!response.ok) throw new Error(data.error || 'Gagal mengambil ide dari server.');
                ideTextarea.value = data.generated_idea;
            } catch (error) {
                alert('Gagal membuat ide: ' + error.message);
            } finally {
                btnBuatIde.disabled = false;
                btnBuatIde.textContent = '✨ Buatkan Ide';
            }
        });

        function renderStructuredResult(scriptText) {
            fullScriptText = scriptText;
            hasilContent.innerHTML = '';
            const lines = scriptText.split('\n');

            lines.forEach(line => {
                if (line.trim() === '') return;
                
                if (line.startsWith('JUDUL:') || line.startsWith('DESKRIPSI:') || line.startsWith('TAGS:') || line.startsWith('HASHTAGS:') || line.startsWith('NARASI:')) {
                    const parts = line.split(':');
                    const title = parts[0].trim();
                    const content = parts.slice(1).join(':').trim();
                    
                    const el = document.createElement('h4');
                    el.className = 'hasil-subjudul';
                    el.textContent = title;
                    if (title === 'NARASI') el.style.marginTop = '20px';
                    hasilContent.appendChild(el);
                    
                    if (content) {
                        const contentEl = document.createElement('p');
                        contentEl.textContent = content;
                        if (title !== 'JUDUL' && title !== 'NARASI') {
                            contentEl.className = `hasil-${title.toLowerCase()}`;
                        }
                        hasilContent.appendChild(contentEl);
                    }
                } else if (line.startsWith('SEGMENT')) {
                    const segmentBlock = document.createElement('div');
                    segmentBlock.className = 'segment-block';
                    
                    const narasiMatch = line.match(/:(.*?)\+/);
                    const promptMatch = line.match(/\(Prompt Visual:(.*?)\)/);

                    const segmentTitleText = line.split(':')[0].trim();
                    const narasiText = narasiMatch ? narasiMatch[1].trim() : line.substring(line.indexOf(':') + 1).trim();
                    const promptText = promptMatch ? `(Prompt Visual: ${promptMatch[1].trim()})` : '';

                    const titleEl = document.createElement('p');
                    titleEl.className = 'segment-title';
                    titleEl.textContent = segmentTitleText;
                    segmentBlock.appendChild(titleEl);

                    const narasiEl = document.createElement('p');
                    narasiEl.className = 'segment-narasi';
                    narasiEl.textContent = narasiText;
                    segmentBlock.appendChild(narasiEl);
                    
                    if (promptText) {
                        const promptEl = document.createElement('p');
                        promptEl.className = 'segment-prompt';
                        promptEl.textContent = promptText;
                        segmentBlock.appendChild(promptEl);
                    }
                    
                    hasilContent.appendChild(segmentBlock);
                }
            });
            actionButtons.style.display = 'flex';
        }

        generateBtn.addEventListener('click', async () => {
            const kategori = document.getElementById('kategori').value;
            const ide = document.getElementById('ide').value;
            const gayaBahasa = document.getElementById('gaya-bahasa').value;
            const gayaVisual = document.getElementById('gaya-visual').value;

            if (!ide.trim()) {
                alert("Bro, ide utamanya jangan kosong ya!");
                return;
            }

            generateBtn.disabled = true;
            generateBtn.textContent = 'Sedang Meracik Ide...';
            hasilContent.innerHTML = '<p>Pelayan sedang menuju dapur... Mohon tunggu sebentar...</p>';
            actionButtons.style.display = 'none';

            try {
                const response = await fetch('/api/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ kategori, ide, gayaBahasa, gayaVisual, task: 'generate_script' }),
                });
                const data = await response.json();
                if (!response.ok) {
                    throw new Error(data.error || 'Dapur sedang sibuk atau ada masalah.');
                }
                renderStructuredResult(data.script);
            } catch (error) {
                console.error("Terjadi kesalahan:", error);
                const errorMessage = `Waduh, ada masalah bro: ${error.message}`;
                hasilContent.innerHTML = `<p class="error-message">${errorMessage}</p>`;
            } finally {
                generateBtn.disabled = false;
                generateBtn.textContent = '✨ Buat Skrip Lengkap!';
            }
        });

        document.getElementById('btnCopy').addEventListener('click', () => {
            navigator.clipboard.writeText(fullScriptText)
                .then(() => { alert('Seluruh hasil berhasil disalin!'); })
                .catch(err => { alert('Gagal menyalin: ' + err); });
        });

        document.getElementById('btnDownload').addEventListener('click', () => {
            const blob = new Blob([fullScriptText], { type: 'text/plain;charset=utf-8' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `wanendira_script_${new Date().getTime()}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        });

        document.getElementById('btnSave').addEventListener('click', () => {
            alert('Fitur "Simpan Riwayat" sedang dalam pengembangan!\nIni akan memerlukan koneksi ke database Firestore.');
        });
    });
    </script>
</body>
</html>
