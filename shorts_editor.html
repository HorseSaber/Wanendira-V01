<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shorts Editor - Wanendira</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Alata&family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root{--navy-dark:#0A192F;--gold-accent:#F7B733;--navy-light:#132F4C;--text-primary:#E6F1FF;--text-secondary:#8892B0;--hover-bg:#1d3b5c;--error-color:#e57373}
        @keyframes spin{to{transform:rotate(360deg)}}
        body{background-color:var(--navy-dark);color:var(--text-primary);font-family:'Nunito',sans-serif;margin:0}
        header{display:flex;justify-content:space-between;align-items:center;padding:20px 5%;border-bottom:1px solid var(--navy-light)}
        .brand-logo{font-family:'Alata',sans-serif;font-size:2em;color:var(--text-primary);text-decoration:none}
        .brand-logo span{color:var(--gold-accent)}
        main{padding:40px 5%;display:flex;flex-direction:column;align-items:center;flex-grow:1}
        .editor-container{width:100%;max-width:800px;display:flex;flex-direction:column;gap:25px}
        h1{font-family:'Alata',sans-serif;font-size:clamp(2rem, 5vw, 2.8rem);text-align:center;color:var(--gold-accent);margin-top:0;margin-bottom:20px}
        label{font-weight:700;font-size:1.1em;margin-bottom:8px;display:block}
        .label-wrapper { display: flex; justify-content: space-between; align-items: center; }
        .ide-generator-btn { background: none; border: 1px solid var(--gold-accent); color: var(--gold-accent); font-size: 0.8em; padding: 4px 8px; border-radius: 5px; cursor: pointer; transition: all 0.2s ease; }
        .ide-generator-btn:hover { background-color: var(--gold-accent); color: var(--navy-dark); }
        textarea{width:100%;padding:15px;border-radius:5px;border:1px solid var(--navy-light);background-color:var(--navy-light);color:var(--text-primary);font-family:'Nunito',sans-serif;font-size:1em;box-sizing:border-box;min-height:150px;resize:vertical}
        .custom-select-wrapper{position:relative;width:100%}.select-hidden{display:none}.select-styled{display:flex;justify-content:space-between;align-items:center;background-color:var(--navy-light);padding:15px;border-radius:5px;border:1px solid var(--navy-light);cursor:pointer;transition:all .2s ease-in-out}.select-styled:hover{border-color:var(--gold-accent)}.select-styled.active{border-color:var(--gold-accent);border-radius:5px 5px 0 0}.select-styled::after{content:"";width:0;height:0;border-left:6px solid transparent;border-right:6px solid transparent;border-top:6px solid var(--text-secondary)}.select-options{display:none;position:absolute;top:100%;left:0;right:0;z-index:99;background-color:var(--navy-light);border-radius:0 0 5px 5px;border:1px solid var(--gold-accent);border-top:0;max-height:250px;overflow-y:auto}.select-options .option-item{padding:15px;color:var(--text-primary);cursor:pointer;transition:all .2s ease-in-out;border-top:1px solid #1a334f}.select-options .option-item:hover{background-color:var(--hover-bg);color:var(--gold-accent)}.optgroup-label{padding:10px 15px;color:var(--gold-accent);font-family:'Alata',sans-serif;font-weight:bold;font-size:0.9em;text-transform:uppercase;border-top:1px solid #1a334f;background-color:var(--navy-dark)}.select-options .option-item:first-of-type, .optgroup-label:first-child{border-top:none}
        .generate-button{background-color:var(--gold-accent);color:var(--navy-dark);border:none;padding:16px 30px;border-radius:5px;cursor:pointer;font-family:'Nunito',sans-serif;font-weight:800;font-size:1.2em;transition:all .3s ease;width:100%;margin-top:10px; display: flex; align-items: center; justify-content: center; gap: 10px;}
        .generate-button:disabled{background-color:var(--text-secondary);cursor:not-allowed}
        .loader { width: 18px; height: 18px; border: 2px solid var(--navy-dark); border-top-color: transparent; border-radius: 50%; animation: spin 1s linear infinite; }
        .hasil-container{display:none;margin-top:30px;width:100%;padding:25px;background-color:var(--navy-light);border-radius:10px;border:1px dashed var(--text-secondary);box-sizing:border-box}
        .hasil-item { margin-bottom: 20px; }
        .hasil-item h4 { font-family:'Alata',sans-serif;color:var(--gold-accent);margin-top:0;font-size:1.2em; margin-bottom: 8px;}
        .hasil-item p { margin: 0; line-height: 1.6; color: var(--text-primary); }
        .hasil-item p.meta-info { color: var(--text-secondary); font-style: italic; }
        .segment-block { background-color: var(--navy-dark); padding: 15px; border-radius: 8px; border-left: 3px solid var(--gold-accent); margin-top: 10px; }
        .segment-title { font-weight: 800; color: var(--text-primary); margin-bottom: 10px !important; }
        .segment-narasi { color: var(--text-primary); line-height: 1.6; }
        .segment-prompt { color: var(--text-secondary); font-size: 0.9em; line-height: 1.5; font-style: italic; margin-top: 15px; padding-top: 15px; border-top: 1px dashed #2c4a6e; }
        #hasil-loading, #hasil-error { text-align: center; padding: 20px; }
        .error-message {color: var(--error-color) !important; font-weight: bold;}
        .action-buttons { display: flex; width: 100%; justify-content: flex-end; gap: 10px; margin-top: 25px; padding-top: 20px; border-top: 1px solid var(--navy-dark); }
        .action-buttons button { font-size: 0.9em; padding: 8px 16px; background-color: transparent; color: var(--gold-accent); border: 1px solid var(--gold-accent); cursor: pointer; border-radius: 5px; transition: all 0.2s ease; display: inline-flex; align-items: center; gap: 6px; }
        .action-buttons button:hover { background-color: var(--gold-accent); color: var(--navy-dark); }
    </style>
</head>
<body>
    <header> <a href="index.html" class="brand-logo">Wanendira<span>.</span></a> </header>
    <main>
        <div class="editor-container">
            <h1>Shorts Editor</h1>
            <div class="custom-select-wrapper"><label for="kategori">1. Kategori Konten</label><select id="kategori" class="select-hidden"><option value="motivasi">Shorts Motivasi</option><option value="cerpen">Shorts Cerita Pendek</option><option value="fakta-sejarah">Shorts Fakta Sejarah</option></select></div>
            <div class="label-wrapper">
                <label for="ide">2. Ide Utamamu</label>
                <button id="btnBuatIde" class="ide-generator-btn">✨ Buatkan Ide</button>
            </div>
            <textarea id="ide" placeholder="Klik 'Buatkan Ide' atau tulis idemu sendiri..."></textarea>
            <div class="custom-select-wrapper"><label for="gaya-bahasa">3. Gaya Bahasa</label><select id="gaya-bahasa" class="select-hidden"><optgroup label="Gaya Motivasi"><option value="Tegas & Santai (Gaya 'Bro')">Tegas & Santai (Gaya 'Bro')</option><option value="Inspiratif & Puitis">Inspiratif & Puitis</option></optgroup><optgroup label="Gaya Narasi"><option value="Narator Dongeng (Hangat & Imajinatif)">Narator Dongeng</option><option value="Pencerita Epik (Dramatis & Megah)">Pencerita Epik</option></optgroup><optgroup label="Gaya Edukasi"><option value="Presenter Antusias (Cepat & Enerjik)">Presenter Antusias</option><option value="Pakar Tenang (Jelas & Berwibawa)">Pakar Tenang</option></optgroup></select></div>
            <div class="custom-select-wrapper"><label for="gaya-visual">4. Gaya Visual</label><select id="gaya-visual" class="select-hidden"><option value="cinematic">Cinematic (Realistis)</option><option value="anime">Anime</option><option value="kartun-3d">Kartun 3D</option></select></div>
            <button id="generateBtn" class="generate-button">✨ Buat Skrip Lengkap!</button>
            <div id="hasilContainer" class="hasil-container">
                <!-- Konten akan dirender di sini oleh JavaScript -->
            </div>
        </div>
    </main>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // BAGIAN 1: LOGIKA DROPDOWN CUSTOM
        document.querySelectorAll('.custom-select-wrapper').forEach(function(wrapper) {
            const selectElement = wrapper.querySelector('select');
            const styledSelect = document.createElement('div');
            styledSelect.setAttribute('class', 'select-styled');
            styledSelect.textContent = selectElement.options[selectElement.selectedIndex].text;
            
            const optionsList = document.createElement('div');
            optionsList.setAttribute('class', 'select-options');
            
            const options = Array.from(selectElement.children);
            
            options.forEach(function(item) {
                if (item.tagName === 'OPTGROUP') {
                    const groupLabel = document.createElement('div');
                    groupLabel.textContent = item.label;
                    groupLabel.classList.add('optgroup-label');
                    optionsList.appendChild(groupLabel);
                    
                    const groupOptions = Array.from(item.children);
                    groupOptions.forEach(function(option) {
                        addOption(option);
                    });
                } else {
                    addOption(item);
                }
            });

            function addOption(option) {
                const optionDiv = document.createElement('div');
                optionDiv.textContent = option.textContent;
                optionDiv.classList.add('option-item');
                optionDiv.setAttribute('data-value', option.value);
                
                optionDiv.addEventListener('click', function(e) {
                    e.stopPropagation();
                    styledSelect.textContent = this.textContent;
                    selectElement.value = this.getAttribute('data-value');
                    optionsList.style.display = 'none';
                    styledSelect.classList.remove('active');
                });
                optionsList.appendChild(optionDiv);
            }
            
            wrapper.appendChild(styledSelect);
            wrapper.appendChild(optionsList);
            
            styledSelect.addEventListener('click', function(e) {
                e.stopPropagation();
                closeAllSelects(this);
                const isHidden = optionsList.style.display === 'none' || optionsList.style.display === '';
                optionsList.style.display = isHidden ? 'block' : 'none';
                this.classList.toggle('active', isHidden);
            });
        });
        
        function closeAllSelects(elmnt) {
            document.querySelectorAll('.select-options').forEach(function(options) {
                if (!elmnt || elmnt.nextSibling !== options) {
                    options.style.display = 'none';
                    if (options.previousSibling && options.previousSibling.classList) {
                       options.previousSibling.classList.remove('active');
                    }
                }
            });
        }
        
        document.addEventListener('click', function() {
            closeAllSelects(null);
        });

        // BAGIAN 2: LOGIKA APLIKASI UTAMA
        const generateBtn = document.getElementById('generateBtn');
        const hasilContainer = document.getElementById('hasilContainer');
        const btnBuatIde = document.getElementById('btnBuatIde');
        const ideTextarea = document.getElementById('ide');
        let fullScriptText = '';

        btnBuatIde.addEventListener('click', handleBuatIde);
        generateBtn.addEventListener('click', handleGenerateScript);

        async function handleBuatIde() {
            const kategori = document.getElementById('kategori').value;
            btnBuatIde.disabled = true;
            btnBuatIde.innerHTML = '<div class="loader"></div>';
            try {
                const response = await fetch('/api/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ task: 'generate_idea', kategori: kategori }),
                });
                const data = await response.json();
                if (!response.ok) throw new Error(data.error || 'Gagal mengambil ide.');
                ideTextarea.value = data.generated_idea;
            } catch (error) {
                alert('Gagal membuat ide: ' + error.message);
            } finally {
                btnBuatIde.disabled = false;
                btnBuatIde.innerHTML = '✨ Buatkan Ide';
            }
        }

        async function handleGenerateScript() {
            const kategori = document.getElementById('kategori').value;
            const ide = ideTextarea.value;
            const gayaBahasa = document.getElementById('gaya-bahasa').value;
            const gayaVisual = document.getElementById('gaya-visual').value;

            if (!ide.trim()) {
                alert("Bro, ide utamanya jangan kosong ya!");
                return;
            }
            setLoadingState(true);
            try {
                const response = await fetch('/api/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ kategori, ide, gayaBahasa, gayaVisual, task: 'generate_script' }),
                });
                const data = await response.json();
                if (!response.ok) throw new Error(data.error || 'Dapur sedang sibuk.');
                fullScriptText = data.script;
                renderSuccessResult(fullScriptText);
            } catch (error) {
                console.error("Terjadi kesalahan:", error);
                renderErrorResult(`Waduh, ada masalah bro: ${error.message}`);
            } finally {
                setLoadingState(false);
            }
        }

        function setLoadingState(isLoading) {
            generateBtn.disabled = isLoading;
            if (isLoading) {
                generateBtn.innerHTML = '<div class="loader"></div> Sedang Meracik...';
                hasilContainer.style.display = 'block';
                hasilContainer.innerHTML = '<div id="hasil-loading" style="text-align: center; padding: 20px;"><div class="loader" style="margin:auto; width:30px; height:30px;"></div><p>Pelayan sedang menuju dapur... Mohon tunggu...</p></div>';
            } else {
                generateBtn.innerHTML = '✨ Buat Skrip Lengkap!';
            }
        }

        function renderSuccessResult(scriptText) {
            hasilContainer.innerHTML = '';
            const lines = scriptText.split('\n');
            let narasiHtml = '';

            lines.forEach(line => {
                if (line.startsWith('SEGMENT')) {
                    const segmentBlock = document.createElement('div');
                    segmentBlock.className = 'segment-block';
                    const narasiMatch = line.match(/:(.*?)\+/);
                    const promptMatch = line.match(/\(Prompt Visual:(.*?)\)/);
                    const segmentTitleText = line.split(':')[0].trim();
                    const narasiText = narasiMatch ? narasiMatch[1].trim() : line.substring(line.indexOf(':') + 1).trim();
                    const promptText = promptMatch ? `(Prompt Visual: ${promptMatch[1].trim()})` : '';
                    segmentBlock.innerHTML = `<p class="segment-title">${segmentTitleText}</p><p class="segment-narasi">${narasiText}</p>`;
                    if (promptText) {
                        segmentBlock.innerHTML += `<p class="segment-prompt">${promptText}</p>`;
                    }
                    narasiHtml += segmentBlock.outerHTML;
                }
            });

            hasilContainer.innerHTML = `
                <div class="hasil-item"><h4>JUDUL</h4><p>${getSectionContent(lines, 'JUDUL:')}</p></div>
                <div class="hasil-item"><h4>DESKRIPSI</h4><p class="meta-info">${getSectionContent(lines, 'DESKRIPSI:')}</p></div>
                <div class="hasil-item"><h4>TAGS</h4><p class="meta-info">${getSectionContent(lines, 'TAGS:')}</p></div>
                <div class="hasil-item"><h4>HASHTAGS</h4><p class="meta-info">${getSectionContent(lines, 'HASHTAGS:')}</p></div>
                <div class="hasil-item"><h4>NARASI SCRIPT</h4>${narasiHtml}</div>
                <div id="actionButtons" class="action-buttons">
                    <button id="btnCopy"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg> Salin</button>
                    <button id="btnDownload"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg> Unduh</button>
                    <button id="btnSave"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg> Simpan</button>
                </div>
            `;
            document.getElementById('btnCopy').addEventListener('click', handleCopy);
            document.getElementById('btnDownload').addEventListener('click', handleDownload);
            document.getElementById('btnSave').addEventListener('click', handleSave);
        }
        
        function renderErrorResult(message) {
            hasilContainer.style.display = 'block';
            hasilContainer.innerHTML = `<div id="hasil-error" style="text-align: center; padding: 20px;"><p class="error-message">${message}</p></div>`;
        }
        
        function getSectionContent(lines, prefix) {
            const line = lines.find(l => l.startsWith(prefix));
            return line ? line.substring(prefix.length).trim() : 'N/A';
        }

        function handleCopy() {
            navigator.clipboard.writeText(fullScriptText)
                .then(() => alert('Seluruh hasil berhasil disalin!'))
                .catch(err => alert('Gagal menyalin: ' + err));
        }
        function handleDownload() {
            const blob = new Blob([fullScriptText], { type: 'text/plain;charset=utf-8' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `wanendira_script_${new Date().getTime()}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }
        function handleSave() {
            alert('Fitur "Simpan Riwayat" sedang dalam pengembangan!');
        }
    });
    </script>
</body>
</html>
